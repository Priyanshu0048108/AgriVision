<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AgriVision - Weed Detection Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f3f9f1;
      --text-color: #212529;
      --accent-color: #4caf50;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Segoe UI', sans-serif;
    }

    .navbar {
      background-color: var(--accent-color);
    }

    .navbar-brand {
      color: #fff !important;
      font-weight: bold;
    }

    .hidden { display: none; }

    .result-img, .result-video {
      max-width: 100%;
      border: 2px solid #ccc;
      margin-top: 10px;
    }

    .theme-toggle {
      position: absolute;
      right: 20px;
      top: 20px;
    }

    .history-entry {
      background: #e7f4ea;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 6px;
    }

    .dark-mode {
      --bg-color: #1e1e1e;
      --text-color: #f0f0f0;
      --accent-color: #66bb6a;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <span class="navbar-brand">üåø AgriVision Dashboard</span>
    <button class="btn btn-light theme-toggle" onclick="toggleTheme()">Toggle Theme</button>
  </div>
</nav>

<div class="container mt-4">

  <!-- Login Section -->
  <div id="loginSection">
    <h3 class="text-center mb-4">üîê User Login</h3>
    <div class="row justify-content-center">
      <div class="col-md-6">
        <input type="email" class="form-control mb-3" id="email" placeholder="Email">
        <input type="password" class="form-control mb-3" id="password" placeholder="Password">
        <button class="btn btn-success w-100" onclick="handleLogin()">Login</button>
      </div>
    </div>
  </div>

  <!-- Dashboard Section -->
  <div id="dashboardSection" class="hidden">
    <h3 class="text-center mb-4">üå± Upload Field Image/Video</h3>

    <!-- Upload Form -->
    <form id="uploadForm" enctype="multipart/form-data">
      <div class="mb-3">
        <input class="form-control" type="file" id="mediaUpload" name="media" accept="image/*,video/*">
      </div>
      <button type="submit" class="btn btn-success">Analyze</button>
    </form>

    <!-- Loading -->
    <div id="loading" class="text-center mt-3 hidden">
      <div class="spinner-border text-success" role="status"></div>
      <p>Processing, please wait...</p>
    </div>

    <!-- Result Display -->
    <div id="resultSection" class="row mt-4 hidden">
      <div class="col-md-6">
        <h5>üñºÔ∏è Annotated Output</h5>
        <img id="resultImage" class="result-img" src="#" style="display:none;">
        <video id="resultVideo" class="result-video" controls style="display:none;"></video>
      </div>
      <div class="col-md-6">
        <h5>üìç Coordinates</h5>
        <ul id="coordinatesList" class="list-group"></ul>
      </div>
    </div>

    <!-- History Section -->
    <div class="mt-5">
      <h4>üïì Upload History</h4>
      <div id="historyContainer"></div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let historyList = [];

  function handleLogin() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    if (email === 'admin@example.com' && password === '123456') {
      alert("Login successful!");
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('dashboardSection').classList.remove('hidden');
    } else {
      alert("Invalid credentials");
    }
  }

  async function toggleTheme() {
    document.body.classList.toggle('dark-mode');
  }

  document.getElementById('uploadForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const mediaFile = document.getElementById('mediaUpload').files[0];
    if (!mediaFile) return alert('Please select a file.');

    const formData = new FormData();
    formData.append('media', mediaFile);

    const loading = document.getElementById('loading');
    const resultSection = document.getElementById('resultSection');
    const resultImage = document.getElementById('resultImage');
    const resultVideo = document.getElementById('resultVideo');
    const coordinatesList = document.getElementById('coordinatesList');
    const historyContainer = document.getElementById('historyContainer');

    loading.classList.remove('hidden');
    resultSection.classList.add('hidden');
    resultImage.style.display = 'none';
    resultVideo.style.display = 'none';
    coordinatesList.innerHTML = '';

    try {
      const response = await fetch('https://your-backend.onrender.com/analyze', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      // Show result
      if (data.media_type === 'image') {
        resultImage.src = data.annotated_url;
        resultImage.style.display = 'block';
      } else if (data.media_type === 'video') {
        resultVideo.src = data.annotated_url;
        resultVideo.style.display = 'block';
      }

      // Show coordinates
      data.coordinates.forEach((coord, i) => {
        const li = document.createElement('li');
        li.classList.add('list-group-item');
        li.textContent = `Point ${i + 1}: (X: ${coord.x}, Y: ${coord.y})`;
        coordinatesList.appendChild(li);
      });

      // Save to history
      const historyEntry = {
        fileName: mediaFile.name,
        type: data.media_type,
        time: new Date().toLocaleString(),
        count: data.coordinates.length
      };
      historyList.push(historyEntry);
      renderHistory();

      resultSection.classList.remove('hidden');
    } catch (error) {
      alert("Error analyzing media.");
      console.error(error);
    } finally {
      loading.classList.add('hidden');
    }
  });

  function renderHistory() {
    const historyContainer = document.getElementById('historyContainer');
    historyContainer.innerHTML = '';
    historyList.slice().reverse().forEach(entry => {
      const div = document.createElement('div');
      div.className = 'history-entry';
      div.innerHTML = `
        <strong>${entry.fileName}</strong><br>
        Type: ${entry.type} | Time: ${entry.time} <br>
        üìç Points Detected: ${entry.count}
      `;
      historyContainer.appendChild(div);
    });
  }
</script>

</body>
</html>
